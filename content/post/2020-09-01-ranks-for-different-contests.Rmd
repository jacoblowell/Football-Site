---
title: Ranks for Different Contests
author: Jake
date: '2020-09-01'
output:
  blogdown::html_page:
    toc: true
    toc_depth: 1
    number_sections: true
slug: ranks-for-different-contests
categories:
  - BestBall
  - NFL
tags: []
---



```{r setup, include=FALSE}
library(knitr)
knitr::opts_chunk$set(echo = FALSE , cache = TRUE , warning = FALSE , message = FALSE #, dpi = 180 , fig.width = 8 , fig.height = 5
                      )

```


```{r}
library(tidyverse)
library(lubridate)
library(plotly)
library(tidyquant)
library(scales)
library(reactable)

options(scipen = 99999)

```





```{r}

library(crosstalk)

Underdog_Ownership <-   Underdog_Ownership <- read_csv("~/Desktop/BestBall/Data/2020/Underdog Ownership.csv")



Underdog_Ownership <-   Underdog_Ownership   %>%  filter(`Draft Size`  > 11) %>%  mutate(Date = as_date(`Picked At`)   , Player = str_c(`First Name` , " " , `Last Name`)  ,
      Entry_Fee =  case_when( `Draft Entry Fee` > 0 ~ `Draft Entry Fee` , TRUE ~ `Tournament Entry Fee`)   , temp_weight_adp = `Pick Number` * Entry_Fee)  %>%  
  select(Date , Player, `Pick Number` , Entry_Fee  , Team, Position , `Draft Size`  , Draft  , temp_weight_adp)   %>%  
  mutate( QB  = case_when( str_detect(Position , "QB" ) ~ 1 , TRUE ~0     ) ) %>%  group_by(Team, Draft) %>% 
  mutate(Teammates =  n() , With_QB   = sum(QB) ) %>% ungroup() %>%  mutate(`With QB` = ifelse(With_QB > 0 ,"Yes","No") )

Underdog_Ownership_Static  <- Underdog_Ownership %>%  group_by(Team, Position, Player)  %>%  
  summarise ( ADP = mean(`Pick Number`) %>%  round(1) , Times_Drafted = n() , Earliest = min(`Pick Number`)   , Latest = max(`Pick Number`)   , Range = Latest - Earliest  ,
            Exposure = sum(Entry_Fee)  ,   Avg_Teamates = (mean(Teammates) - 1 ) %>%  round(1)  , With_QB_Rate  = mean(With_QB) %>%  round(1)     , Weighted_ADP =  ( sum(temp_weight_adp )/  sum(Exposure  )) %>% round(1))%>% 
  ungroup()  %>%  select(  - Earliest , - Latest , -ADP  )  %>%  relocate(Range, .after = last_col()) %>%  select(-Times_Drafted , - Range)


underdog_shared <- SharedData$new(Underdog_Ownership_Static)


Ownership_table  <- underdog_shared   %>%   reactable( columns = list(
 Team = colDef(minWidth = 50)  ,
 Position = colDef(minWidth = 60)  ,
Exposure = colDef(minWidth = 75 , format = colFormat(
  prefix = "$",
  separators = TRUE,
  digits = 0)),
With_QB_Rate =   colDef(format = colFormat(percent = TRUE, digits = 0)) 
#, Weighted_ADP =   colDef( ) ,
#Avg_Teamates =   colDef( )
#,Range = colDef(minWidth = 50)  
)  ,#filterable = TRUE  ,#searchable = TRUE ,  
style = list(fontFamily = "Work Sans, sans-serif", fontSize = "12px"),fullWidth = TRUE,
  width = "auto"  #, defaultPageSize = 12
)




# bootstrap columns
library(htmltools)



div(
h3("Ownership Table with Filtering") ,

bscols(
  # bootstrap is built off a 12 wide grid system,
  # so we have 1/6 and 5/6 width below
  widths = c(1.5,5.25,5.25),
  list(

  
  
  # add our table next to the filters
Ownership_table  ,

#####3


  filter_select("team", "Team", underdog_shared, ~Team  , multiple =  FALSE),

######

ggplotly(underdog_shared %>%  ggplot(aes(x = Weighted_ADP, y = Exposure  ,color = Position , label = Player)) +
     geom_point(aes(text = str_glue("Player: {Player}")   ) , size = 0.1)+ 
  theme_tq() + scale_color_tq() +
      geom_text(check_overlap = TRUE , size = 3 , nudge_y = 1) + theme(legend.position="none")  )  

))  )

```









```{r}

Underdog_Ownership  <- Underdog_Ownership %>% mutate(Teammates = Teammates -1) %>% 
  mutate(  Stacked = case_when (   QB * Teammates   > 0.5  ~ "Stacked"  ,   QB != 1 & With_QB ==1 ~ "Stacked"  , TRUE ~ "Not Stacked"    ) )%>%  mutate(Stacked = as.factor(Stacked))

underdog_picks_shared <- SharedData$new(Underdog_Ownership)

div(
h3("Ownership Table with Filtering") ,

bscols(
  # bootstrap is built off a 12 wide grid system,
  # so we have 1/6 and 5/6 width below
  widths = c(1.5,5.25,5.25),
  list(
######
ggplotly(    
underdog_picks_shared  %>%  ggplot(aes( x = Date  , y = `Pick Number`  , color = Stacked  , shape = Stacked, label = Player)) +  
     geom_point(aes(text = str_glue("Player: {Player}")   ) , size = 2)+ 
  theme_tq() + scale_color_tq() +
      geom_text(check_overlap = TRUE , size = 2 , nudge_y = 8) + theme(legend.position="none") +
  labs(title = "Underdog draft picks over time"  , caption = "Source: Underdog.com")
)  ,  filter_select("team", "Team", underdog_picks_shared, ~Team , multiple = FALSE))
))

```





```{r}
stack <- Underdog_Ownership %>% mutate(Teammates = Teammates -1) %>% 
  mutate( Stack =  Teammates * QB  , Stacked = ifelse(QB * Teammates  > 0.5 , 1 ,0)) %>%  group_by(Draft) %>%  summarise(Stacks = sum(Stacked)  , Stacked_players = sum(Stack)) %>% 
  ungroup()
  
stack %>% ggplot(aes(x= Stacks)) + geom_histogram()


stack %>% ggplot(aes(x= Stacked_players , fill= as.factor(Stacks))) + geom_histogram() + labs(title = "Underdog Stacking")


stack %>% ggplot(aes(x= Stacked_players , fill= as.factor(Stacks))) + geom_histogram() + facet_wrap(~Stacks) + 
  labs(title = "Stacked Players by number of stacks") + theme(legend.position="none")  


```





```{r}


Underdog_Ownership_Static %>% filter(Position == "QB")  %>%    select( -Position , -With_QB_Rate) %>%   reactable( columns = list(
 Team = colDef(minWidth = 50)  ,
Exposure = colDef(minWidth = 75 , format = colFormat(
  prefix = "$",
  separators = TRUE,
  digits = 0))
)  ,
style = list(fontFamily = "Work Sans, sans-serif", fontSize = "12px"),fullWidth = TRUE,
  width = "auto"   , defaultPageSize = 30
)


```





### If qb





